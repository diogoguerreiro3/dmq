<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DMQ ‚Äî Room</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/normalize.js@latest"></script>
    <style>
        body { padding: 0; }

        /* ---- Top bar ---- */
        .topbar {
            position: fixed; top:0; left:0; right:0;
            height: 64px;
            background: rgba(13,13,18,0.90);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center;
            padding: 0 32px;
            z-index: 100;
            gap: 18px;
        }
        .topbar-brand {
            font-family: 'Cinzel', serif;
            font-size: 20px; font-weight: 700;
            background: linear-gradient(135deg, #c4b5fd, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            flex-shrink: 0;
        }
        .topbar-actions {
            margin-left: auto;
            flex-shrink: 0;
            display: flex; gap: 12px;
        }
        .topbar-actions .btn_red { padding: 9px 20px; font-size: 14px; }

        /* ---- Page layout ---- */
        .page-content {
            padding-top: 84px;
            max-width: 1400px;
            margin: 0 auto;
            padding-left: 32px;
            padding-right: 32px;
            padding-bottom: 48px;
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 24px;
            align-items: start;
        }

        /* ---- Left column ---- */
        .main-col { display: flex; flex-direction: column; gap: 20px; }

        /* ---- Song card ---- */
        .song-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 28px;
            box-shadow: var(--shadow-card);
            display: flex;
            gap: 28px;
            align-items: flex-start;
        }
        .song-cover {
            flex-shrink: 0;
            width: 286px;
            height: 430px;
            border-radius: var(--radius-md);
            object-fit: cover;
            border: 1px solid rgba(167,139,250,0.2);
            background: var(--bg-elevated);
            display: none;
            box-shadow: 0 12px 40px rgba(0,0,0,0.7), 0 0 0 1px rgba(167,139,250,0.1);
        }
        .song-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0;
            min-height: 430px;
        }

        /* ---- Song status display (replaces "Now Playing" title) ---- */
        .song-status {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 24px;
        }
        .song-number {
            font-family: 'Cinzel', serif;
            font-size: 20px;
            font-weight: 700;
            color: #c4b5fd;
            letter-spacing: 0.14em;
            text-transform: uppercase;
        }
        .song-state {
            font-family: 'Cinzel', serif;
            font-size: 34px;
            font-weight: 700;
            color: #f0eaff;
            line-height: 1.15;
            text-shadow: 0 2px 20px rgba(167,139,250,0.4);
        }
        .song-countdown {
            font-family: 'Nunito', sans-serif;
            font-size: 17px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        .song-countdown span {
            color: var(--yellow);
            font-weight: 700;
            font-family: 'Cinzel', serif;
        }

        /* Difficulty text */
        #difficulty_text {
            color: var(--text-secondary);
            font-size: 18px;
            font-family: 'Nunito', sans-serif;
            font-weight: 500;
            margin-bottom: 20px;
        }

        /* Listen button */
        #button_listen {
            align-self: flex-start;
            padding: 14px 28px;
            font-size: 16px;
            letter-spacing: .05em;
        }

        /* ---- Reply form ---- */
        .reply-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px 28px;
            box-shadow: var(--shadow-card);
        }
        .reply-label {
            font-size: 12px;
            letter-spacing: .12em;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 14px;
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
            display: block;
        }
        .reply-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        /* Input takes ALL remaining width */
        .suggestions-wrap {
            position: relative;
            flex: 1;
            min-width: 0;
        }
        #reply_text {
            width: 100%;
            padding: 14px 18px;
            font-size: 16px;
            border-radius: var(--radius-md);
            /* Hide browser default bottom border/line styling */
            outline: none;
            box-shadow: none;
        }
        /* Hide the default browser autocomplete underline that appears */
        #reply_text::-webkit-contacts-auto-fill-button,
        #reply_text::-webkit-credentials-auto-fill-button { visibility: hidden; }

        /* Suggestion dropdown */
        #sugestions {
            position: absolute;
            top: calc(100% + 4px);
            left: 0; right: 0;
            z-index: 50;
        }

        .reply-actions { display: flex; gap: 10px; flex-shrink: 0; }
        .reply-actions .btn,
        .reply-actions .btn_yellow { padding: 14px 24px; font-size: 15px; }

        /* ---- Final message ---- */
        #final_message {
            text-align: center;
            color: var(--yellow);
            font-size: 15px;
            padding: 14px;
            background: rgba(251,191,36,.08);
            border: 1px solid rgba(251,191,36,.2);
            border-radius: var(--radius-md);
            display: none;
        }
        #final_message:not(:empty) { display: block; }

        /* ---- Right column ---- */
        .right-col {
            display: flex;
            flex-direction: column;
            gap: 16px;
            position: sticky;
            top: 84px;
        }

        /* ---- Volume card (right column) ---- */
        .volume-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 18px 20px;
            box-shadow: var(--shadow-card);
        }
        .volume-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
        }
        .volume-header h3 {
            font-size: 12px;
            letter-spacing: .1em;
            text-transform: uppercase;
            color: var(--text-muted);
            font-family: 'Nunito', sans-serif;
            font-weight: 700;
        }
        .volume-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        #volume-slider { flex: 1; width: auto; }
        #volume-value {
            min-width: 40px; text-align: right;
            color: var(--accent); font-size: 14px;
            font-weight: 700; font-family: 'Cinzel', serif;
        }
        .volume-hint {
            color: var(--text-muted);
            font-size: 11px;
            margin-top: 10px;
        }

        /* ---- Scoreboard (right column) ---- */
        .players-col {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-card);
        }
        .players-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 10px;
        }
        .players-header h2 {
            font-size: 13px; letter-spacing: .1em;
            text-transform: uppercase; color: var(--text-muted);
            font-weight: 700;
        }
        #content {
            list-style: none;
            padding: 12px 14px;
            margin: 0;
            max-height: 60vh;
            overflow-y: auto;
        }
        .player-row {
            display: flex; align-items: center; gap: 10px;
            padding: 12px 14px;
            border-radius: 10px;
            margin-bottom: 7px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            transition: var(--transition);
            font-size: 15px;
            font-weight: 600;
            flex-wrap: wrap;
        }
        .player-row:hover { border-color: var(--border-glow); }
        .pr-badge {
            margin-left: auto;
            padding: 4px 12px;
            background: rgba(167,139,250,.15);
            border: 1px solid rgba(167,139,250,.25);
            border-radius: 99px;
            color: var(--accent);
            font-size: 13px;
            font-weight: 700;
            font-family: 'Cinzel', serif;
        }
        .pr-movie {
            font-size: 13px;
            display: block; width: 100%;
            padding-left: 4px;
            margin-top: 2px;
        }

        /* Hide plyr controls */
        .plyr--audio .plyr__controls { display: none; }

        @keyframes fadeUp {
            from { opacity:0; transform:translateY(10px); }
            to   { opacity:1; transform:translateY(0); }
        }
        .animate-in { animation: fadeUp .4s ease both; }
        .animate-in:nth-child(2) { animation-delay:.08s; }
        .animate-in:nth-child(3) { animation-delay:.15s; }
    </style>
</head>
<body>

    <!-- Top bar ‚Äî just brand + return -->
    <nav class="topbar">
        <div class="topbar-brand">üéµ DMQ</div>
        <!-- Hidden span keeps audio_info for JS logic (submit check) -->
        <span id="audio_info" style="display:none;"></span>
        <div class="topbar-actions">
            <a onclick="returnLobby()" class="btn_red">‚Üê Return to Lobby</a>
        </div>
    </nav>

    <div class="page-content">
        <!-- LEFT: main gameplay column -->
        <div class="main-col">

            <!-- Song card -->
            <div class="song-card animate-in">
                <img id="song_img" class="song-cover" src="" alt="Cover">
                <div class="song-info">
                    <!-- Status display ‚Äî parsed from audio_info -->
                    <div class="song-status">
                        <div class="song-number" id="song_number">Waiting‚Ä¶</div>
                        <div class="song-state" id="song_state">Ready to Play</div>
                        <div class="song-countdown" id="song_countdown" style="display:none;">
                            ‚è≥ <span id="countdown_val"></span> seconds remaining
                        </div>
                    </div>

                    <div id="difficulty_text"></div>

                    <button id="button_listen" class="btn_green">
                        üéß Click to Listen
                    </button>
                </div>
            </div>

            <!-- Reply form -->
            <div class="reply-card animate-in">
                <span class="reply-label">Your Answer</span>
                <form id="form_reply">
                    <div class="reply-row">
                        <div class="suggestions-wrap">
                            <input type="text" id="reply_text" name="input" maxlength="70"
                                   placeholder="Write the movie name‚Ä¶" autocomplete="off">
                            <ul id="sugestions"></ul>
                        </div>
                        <div class="reply-actions">
                            <button id="submit_button" type="submit" class="btn">Reply</button>
                            <button onclick="skip()" type="button" class="btn_yellow">Skip</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Final message -->
            <div id="final_message"></div>
        </div>

        <!-- RIGHT: volume + scoreboard -->
        <div class="right-col animate-in">

            <!-- Volume -->
            <div class="volume-card">
                <div class="volume-header">
                    <span style="font-size:18px;">üîä</span>
                    <h3>Volume</h3>
                </div>
                <div class="volume-row">
                    <span style="font-size:15px; color:var(--text-muted);">üîà</span>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.2">
                    <span style="font-size:15px; color:var(--text-muted);">üîä</span>
                    <span id="volume-value">20%</span>
                </div>
                <p class="volume-hint">üí° Scroll on the slider to adjust volume</p>
            </div>

            <!-- Scoreboard -->
            <div class="players-col">
                <div class="players-header">
                    <span style="color:var(--accent);font-size:16px;">üë•</span>
                    <h2>Scoreboard</h2>
                </div>
                <ul id="content"></ul>
            </div>
        </div>
    </div>

    <!-- Hidden audio -->
    <audio id="player" style="display:none" hidden>
        <source src="{{ url_for('play') }}" type="audio/mpeg">
    </audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <script>
        var socket = io({ transports:['polling','websocket'], timeout:20000, reconnection:true });

        var audio_info    = document.getElementById('audio_info');
        var volume_slider = document.getElementById('volume-slider');
        var volume_value  = document.getElementById('volume-value');
        var reply_text    = document.getElementById("reply_text");
        var sugestions    = document.getElementById("sugestions");
        var song_img      = document.getElementById("song_img");
        var button_listen = document.getElementById("button_listen");
        var final_message = document.getElementById('final_message');
        var difficulty_text = document.getElementById('difficulty_text');

        // Status display elements
        var song_number   = document.getElementById('song_number');
        var song_state    = document.getElementById('song_state');
        var song_countdown = document.getElementById('song_countdown');
        var countdown_val  = document.getElementById('countdown_val');

        /* Parse and render audio_info string like "[8] Listen Carefully! (13)"
           or "[8] Monsters, Inc - 38 - Fungus Hall Exit.mp3 (13)" */
        function renderAudioInfo(raw) {
            audio_info.innerHTML = raw; // keep hidden span updated for submit check

            // Extract [N] song number
            var numMatch = raw.match(/\[(\d+)\]/);
            var songNum = numMatch ? numMatch[1] : null;

            // Extract (N) seconds remaining
            var secMatch = raw.match(/\((\d+)\)/);
            var seconds = secMatch ? secMatch[1] : null;

            // Get state text: everything after "] " up to the "(" or end
            var stateMatch = raw.match(/\]\s*(.+?)(?:\s*\(|$)/);
            var stateText = stateMatch ? stateMatch[1].trim() : raw;
            // Strip .mp3 extension if present (filename shown during reveal)
            stateText = stateText.replace(/\.mp3$/i, '').trim();

            song_number.textContent = songNum ? 'Song ' + songNum : 'Waiting‚Ä¶';
            song_state.textContent = stateText || 'Ready';

            if(seconds !== null) {
                song_countdown.style.display = 'block';
                countdown_val.textContent = seconds;
            } else {
                song_countdown.style.display = 'none';
            }
        }

        /* Volume display */
        function updateVolumeDisplay(val) {
            var pct = Math.round(parseFloat(val) * 100);
            volume_value.textContent = pct + '%';
            volume_slider.style.background =
                'linear-gradient(to right, #a78bfa ' + pct + '%, #1c1c28 ' + pct + '%)';
        }
        updateVolumeDisplay(volume_slider.value);

        /* Player */
        const player = new Plyr('#player', { hideControls: true });
        player.on('ready', () => { player.volume = parseFloat(volume_slider.value); });

        const audioCtx = new AudioContext();
        const gainNode = audioCtx.createGain();
        gainNode.gain.value = 0.5;

        /* Socket events */
        socket.on('title_refresh', function(data) {
            renderAudioInfo(data);
        });

        socket.on('music_content', function(data) {
            var d = JSON.parse(data);
            if(d.current_difficulty == "") {
                difficulty_text.innerHTML = "";
                song_img.style.display = 'none';
            } else {
                difficulty_text.innerHTML = d.current_difficulty + "% [" + d.current_default_difficulty + "] (" + d.count + ")";
                updateURLImage();
            }
        });

        song_img.onerror = function() { song_img.style.display = 'none'; };
        song_img.onload  = function() { song_img.style.display = 'block'; };

        socket.on('audio_play', function(data) {
            var d = JSON.parse(data);
            if(player.paused && d.command === 'play') {
                fetch('/current_music')
                .then(r => r.json())
                .then(data => {
                    player.source = {
                        type:'audio', title:'current_music',
                        sources:[{ src: data.url, type:'audio/mpeg' }]
                    };
                })
                .catch(e => console.error(e));
                playSong(d.time);
                reply_text.value = "";
            } else if (!player.paused && d.command === 'pause') {
                player.pause();
            }
        });

        async function playSong(t) {
            try {
                if(player !== undefined) {
                    player.on('ready', () => {
                        player.play();
                        player.on('loadeddata', () => { player.currentTime = parseInt(t); })
                        .catch(e => console.error(e));
                    }).catch(e => console.error(e));
                }
            } catch(e) { console.error(e); }
        }

        /* Block/unblock reply */
        socket.on('block_replies', function(data) {
            var d = JSON.parse(data);
            var btn = document.getElementById("submit_button");
            if(d.command === 'block') {
                btn.disabled = true;
                btn.classList.remove("btn"); btn.classList.add("btn_gray");
                block_reply = true;
            } else if(d.command === 'unblock') {
                btn.disabled = false;
                btn.classList.remove("btn_gray"); btn.classList.add("btn");
                block_reply = false;
            }
        });

        /* Volume: slider + scroll wheel */
        volume_slider.addEventListener('input', function() {
            player.volume = parseFloat(this.value);
            updateVolumeDisplay(this.value);
        });
        volume_slider.addEventListener('wheel', function(e) {
            e.preventDefault();
            var v = parseFloat(this.value) + (e.deltaY < 0 ? 0.05 : -0.05);
            v = Math.max(0, Math.min(1, v));
            this.value = v;
            player.volume = v;
            updateVolumeDisplay(v);
        }, { passive: false });

        /* Autocomplete */
        reply_text.addEventListener("input", function() {
            var q = reply_text.value.toLowerCase();
            sugestions.innerHTML = "";
            if(!q) return;
            fetch('/get_movies_with_alternatives')
                .then(r => r.json())
                .then(function(movies_list) {
                    var unique = [...new Set(movies_list)];
                    unique.forEach(function(movie) {
                        if(movie.toLowerCase().indexOf(q) != -1) {
                            var item = document.createElement("li");
                            item.textContent = movie;
                            sugestions.appendChild(item);
                            item.addEventListener("click", function() {
                                reply_text.value = movie;
                                sugestions.innerHTML = "";
                            });
                        }
                    });
                });
        });

        /* Arrow keys for suggestions */
        document.addEventListener("keydown", function(e) {
            var focused = sugestions.querySelector('li.focused');
            var items = sugestions.querySelectorAll('li');
            if(e.key === "ArrowDown") {
                e.preventDefault();
                var next = focused ? (focused.nextElementSibling || items[0]) : items[0];
                if(next) { if(focused) focused.classList.remove('focused'); next.classList.add('focused'); next.scrollIntoView({behavior:'smooth',block:'nearest'}); }
            } else if(e.key === "ArrowUp") {
                e.preventDefault();
                var prev = focused ? (focused.previousElementSibling || items[items.length-1]) : items[items.length-1];
                if(prev) { if(focused) focused.classList.remove('focused'); prev.classList.add('focused'); prev.scrollIntoView({behavior:'smooth',block:'nearest'}); }
            } else if(e.key === "Enter" && focused) {
                e.preventDefault();
                reply_text.value = focused.textContent;
                sugestions.innerHTML = "";
            }
        });
        document.addEventListener('click', function(e) {
            if(!sugestions.contains(e.target)) {
                sugestions.querySelectorAll('li').forEach(i => i.classList.remove('focused'));
            }
        });

        /* Submit */
        var block_reply = false;
        document.getElementById("form_reply").addEventListener("submit", function(e) {
            e.preventDefault();
            if(e.submitter && e.submitter.innerHTML === "Reply" &&
               audio_info.innerHTML.includes("Listen Carefully") && !block_reply) {
                socket.emit('/send_movie', this.elements["input"].value);
            }
        });

        /* Scoreboard refresh */
        var list_users = document.getElementById('content');
        function refreshPlayers() {
            $.get('/get_replys_and_points', function(data) {
                list_users.innerHTML = '';
                data.forEach(function(el) {
                    var li = document.createElement('li');
                    li.className = 'player-row';

                    var nameSpan = document.createElement('span');
                    nameSpan.textContent = el.username;
                    nameSpan.style.flex = '1';

                    var badge = document.createElement('span');
                    badge.className = 'pr-badge';
                    badge.textContent = el.points + ' pts';

                    // Status icon ‚Äî no movie names ever shown (others can see this!)
                    var statusIcon = document.createElement('span');
                    statusIcon.style.cssText = 'font-size:17px; flex-shrink:0; margin-right:4px;';

                    if(el.correct == "false") {
                        li.style.borderColor = 'rgba(248,113,113,.35)';
                        nameSpan.style.color = '#f87171';
                        statusIcon.textContent = '‚úó';
                        statusIcon.style.color = '#f87171';
                    } else if(el.correct == "true") {
                        li.style.borderColor = 'rgba(52,211,153,.35)';
                        nameSpan.style.color = '#34d399';
                        statusIcon.textContent = '‚úì';
                        statusIcon.style.color = '#34d399';
                    } else if(el.skip) {
                        nameSpan.style.color = '#fbbf24';
                        statusIcon.textContent = '‚è≠';
                        statusIcon.style.color = '#fbbf24';
                    } else if(el.movie) {
                        // Typing but not yet judged
                        statusIcon.textContent = '‚úçÔ∏è';
                    }

                    // Build: [icon] [name ............] [pts]
                    if(statusIcon.textContent) li.appendChild(statusIcon);
                    li.appendChild(nameSpan);
                    li.appendChild(badge);

                    list_users.appendChild(li);
                });
                setTimeout(refreshPlayers, 500);
            });
        }
        $(document).ready(function() { refreshPlayers(); });

        /* Return to lobby */
        function returnLobby() {
            fetch("/return_lobby", {method:'POST', headers:{'Content-Type':'application/json'}})
            .then(r => r.ok ? r.json() : Promise.reject())
            .then(data => {
                if(data.status == "Message receive with success" && data.player == "player") {
                    window.location.href = "{{ url_for('lobby') }}";
                }
            }).catch(e => console.error(e));
        }

        socket.on('go_to_lobby', function() { window.location.href = "{{ url_for('lobby') }}"; });
        socket.on('final_message', function() {
            final_message.innerHTML = "‚ö† The room will close at the end of the song.";
        });

        /* Image update */
        function updateURLImage() {
            fetch("/image", {method:'POST', headers:{'Content-Type':'application/json'}})
            .then(r => r.ok ? r.json() : Promise.reject())
            .then(data => {
                if(data.status == "Message receive with success" && data.url) {
                    song_img.src = data.url;
                }
            }).catch(e => console.error(e));
        }

        /* Listen button */
        button_listen.onclick = function() { button_listen.style.display = 'none'; };

        /* Skip */
        function skip() {
            fetch("/skip", {method:'POST', headers:{'Content-Type':'application/json'}})
            .then(r => r.json())
            .catch(e => console.error(e));
        }
    </script>
</body>
</html>
