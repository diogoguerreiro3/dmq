<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>DMQ</title>
    <link rel="stylesheet" type="text/css" href="/style.css">
</head>
<body>
    <div>
        <h2 id="audio_info"></h2>
        <audio id="audio-player" controls>
            <!-- style="display: none;" -->
            <source id="audio-src" src="{{ url_for('play') }}" type="audio/mpeg">
            Your browser doesn't support this audio tag.
        </audio>
        <div id="volume-control" class="container">
            <label for="volume-slider">Volume Control:</label>
            <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.5" style="margin-bottom: 0;">
        </div>
        <br>

        <input type="text" id="reply_text" placeholder="Write the movie...">
        <ul id="sugestions"></ul>
        <br>
        
        <a href="{{ url_for('index') }}" class="btn">Come Back</a>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
    <script>
        
        var socket = io.connect('http://' + document.domain + ':' + location.port);
        var audio_info = document.getElementById('audio_info');
        var audio_player = document.getElementById('audio-player');
        var volume_slider = document.getElementById('volume-slider');

        socket.on('title_refresh', function(data) {
            audio_info.innerHTML = data;
        });

        socket.on('audio_play', function(data) {
            var data_json = JSON.parse(data);
            if(audio_player.paused && data_json.command === 'play') {
                document.getElementById('audio-src').src = "{{ url_for('play') }}";
                audio_player.load();
                audio_player.currentTime = data_json.time;
                audio_player.play();
            } else if (!audio_player.paused && data_json.command === 'pause') {
                audio_player.pause();
            }
        });

        
        /*Volume Control*/
        volume_slider.addEventListener('input', function() {
            audio_player.volume = volume_slider.value;
        });

        audio_player.volume = volume_slider.value;


        /* Autocomplete text */
        var reply_text = document.getElementById("reply_text");
        var sugestions = document.getElementById("sugestions");

        reply_text.addEventListener("input", function() {
            var movie_texted = reply_text.value.toLowerCase();
            sugestions.innerHTML = ""; // Limpa a lista de sugestões

            // Fazer uma solicitação AJAX para obter a lista de palavras do servidor Flask
            fetch('/get_movies')
                .then(function(response) {
                    return response.json();
                })
                .then(function(movies_list) {
                    movies_list.forEach(function(movie) {
                        console.log(movie + " " + movie_texted)
                        if (movie.toLowerCase().startsWith(movie_texted)) {
                            console.log(movie)
                            var item = document.createElement("li");
                            item.textContent = movie;
                            sugestions.appendChild(item);

                            item.addEventListener("click", function() {
                                reply_text.value = movie;
                                sugestions.innerHTML = ""; // Limpa a lista de sugestões ao selecionar uma sugestão
                            });
                        }
                    });
                });
        });

        /*var count = 5;
        while (count > 0) {
            counter.innerHTML = "Wait " + count + " seconds ...";
            setTimeout(refreshPlayers, 1000);
            count--;
        }
        

        function play_music() {
            $.get('/get_players', function(data) {
                list.innerHTML = '';
                data.forEach(function (element) {
                    var li = document.createElement('li');
                    li.appendChild(document.createTextNode(element)); 
                    
                });
                setTimeout(refreshPlayers, 1000); // Update each 1 second (1000 ms)
            });
        }*/

        //socket.emit('play_audio', { command: 'play' });

        // Controlar a reprodução do áudio
        // document.querySelector('#audio-player').addEventListener('play', function() {
        //     socket.emit('play_audio', { command: 'play' });
        // });
    </script>
</body>
</html>
